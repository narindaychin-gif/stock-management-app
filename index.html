<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Professional Stock Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <style>
        body { font-family: 'Inter', sans-serif; }
        #login-page { display: flex; }
        .app-content { display: none; }
        .app-content.active { display: flex; }
        .modal-overlay { transition: opacity 0.3s ease; }
        .modal-container { transition: transform 0.3s ease; max-height: 90vh; overflow-y: auto; }
        .sidebar-link.active { background-color: #4f46e5; color: white; }
        .input {
            margin-top:0.25rem; display:block; width:100%; padding:0.5rem 0.75rem;
            border:none; border-radius:0.375rem; background:#fff; font-size:0.875rem;
            line-height:1.25rem;
            box-shadow:0 1px 2px rgb(0 0 0 / 5%),0 1px 3px rgb(0 0 0 / 10%);
        }
        .input::placeholder{ color:#9ca3af; }
        .input:focus{
            outline: none;
            box-shadow:0 0 0 2px rgba(79,70,229,.5),0 1px 2px rgb(0 0 0 / 5%),0 1px 3px rgb(0 0 0 / 10%);
        }
        .input-dark {
            margin-top:0.25rem; display:block; width:100%; padding:0.75rem 1rem;
            border: 1px solid #4a5568; border-radius:0.375rem; background:#2d3748;
            color: #e2e8f0; font-size:0.875rem; line-height:1.25rem;
        }
        .input-dark::placeholder { color:#a0aec0; }
        .input-dark:focus {
            outline: none;
            border-color: #059669; /* Emerald color */
            box-shadow: 0 0 0 2px rgba(5, 150, 105, 0.5);
        }
        .table-scroll {
            overflow-x: auto; overflow-y: auto;
            scrollbar-gutter: stable;
        }
        .table-scroll::-webkit-scrollbar { height: 10px; width: 10px; }
        .table-scroll::-webkit-scrollbar-track { background: #f3f4f6; border-radius: 9999px; }
        .table-scroll::-webkit-scrollbar-thumb { background-color: #9ca3af; border-radius: 9999px; border: 2px solid #f3f4f6; }
        .table-scroll::-webkit-scrollbar-thumb:hover { background-color: #6b7280; }

        #transport-page thead tr {
            position: -webkit-sticky; /* For Safari compatibility */
            position: sticky;
            top: 0;
            z-index: 10;
        }

        #stock-page thead tr:nth-child(1) {
            position: -webkit-sticky; /* For Safari compatibility */
            position: sticky;
            top: 0;
            z-index: 10;
        }
        #stock-page thead tr:nth-child(2) {
            position: -webkit-sticky;
            position: sticky;
            top: 3rem; /* 48px, which is the calculated height of the first header row (py-4 + line-height) */
            z-index: 10;
        }

        #stock-page th, #stock-page td,{
          white-space: normal;
        }
        #stock-page tbody td:nth-child(6) {
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }
        #stock-page thead tr:nth-child(1) th:nth-child(6) {
          white-space: nowrap; /* header only */
        }

        #transport-page td, #transport-page th {
            white-space: normal;
            line-height: 1.25rem;
            vertical-align: top;
        }

        #transport-page table { table-layout: fixed; }
        #transport-page th:nth-child(1),  #transport-page td:nth-child(1)  { width: 3.5rem; }
        #transport-page th:nth-child(2),  #transport-page td:nth-child(2)  { width: 9rem; white-space: nowrap;}
        #transport-page th:nth-child(3),  #transport-page td:nth-child(3)  { width: 10rem; }
        #transport-page th:nth-child(4),  #transport-page td:nth-child(4)  { width: 7rem; }
        #transport-page th:nth-child(5),  #transport-page td:nth-child(5)  { width: 7rem;  white-space:nowrap; }
        #transport-page th:nth-child(6),  #transport-page td:nth-child(6)  { width: 6rem;  text-align:right; }
        #transport-page th:nth-child(7),  #transport-page td:nth-child(7)  { width: 6rem;  text-align:right; }
        #transport-page th:nth-child(8),  #transport-page td:nth-child(8)  { width: 12rem; white-space:nowrap; }
        #transport-page th:nth-child(9),  #transport-page td:nth-child(9)  { width: 9rem;  white-space:nowrap; }
        #transport-page th:nth-child(10), #transport-page td:nth-child(10) { width: 7rem;  text-align:right; }
        #transport-page th:nth-child(11), #transport-page td:nth-child(11) { width: 12rem; }
        #transport-page th:nth-child(12), #transport-page td:nth-child(12) { width: 8rem; }
        #transport-page th:nth-child(13), #transport-page td:nth-child(13) { width: 8rem; white-space: nowrap;}

        #transport-page thead th:nth-child(6),
        #transport-page thead th:nth-child(7),
        #transport-page thead th:nth-child(10) { text-align:right; }

        #invoices-page table { table-layout: fixed; }
        #invoices-page th, #invoices-page td {
          overflow: hidden;
          text-overflow: ellipsis;
        }

        #invoices-page th:nth-child(1),  #invoices-page td:nth-child(1)  { width: 3.5rem; }
        #invoices-page th:nth-child(2),  #invoices-page td:nth-child(2)  {
          width: 10rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        #invoices-page th:nth-child(3),  #invoices-page td:nth-child(3)  { width: 12rem; }
        #invoices-page th:nth-child(4),  #invoices-page td:nth-child(4)  { width: 8.5rem; }
        #invoices-page th:nth-child(5),  #invoices-page td:nth-child(5)  { width: auto; white-space: nowrap; }
        #invoices-page th:nth-child(6),  #invoices-page td:nth-child(6)  { width: 9rem; white-space: nowrap; }
        #invoices-page th:nth-child(4),  #invoices-page td:nth-child(4) {
          white-space: nowrap; text-align: center;
        }

        #invoices-page th:nth-child(7),  #invoices-page td:nth-child(7),
        #invoices-page th:nth-child(8),  #invoices-page td:nth-child(8),
        #invoices-page th:nth-child(9), #invoices-page td:nth-child(9),
        #invoices-page th:nth-child(10), #invoices-page td:nth-child(10) {
          text-align: right;
        }

        #invoices-page th:nth-child(9), #invoices-page td:nth-child(9) {
          white-space: nowrap;
        }
         #stock-page tfoot th,
         #transport-page tfoot th,
         #invoices-page tfoot th {
            position: sticky;
            bottom: 0;
            background-color: #f3f4f6;
            z-index: 10;
        }
        .report-panel { display: none; }
        .report-panel.active { display: block; }
        .report-tab-button.active {
            background-color: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }

        @media print {
            body * {
                visibility: hidden;
            }
            .printable-area, .printable-area * {
                visibility: visible;
            }
            .printable-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            .no-print {
                display: none !important;
            }
            #invoice-preview-content {
                border: none !important;
                box-shadow: none !important;
                padding: 0 !important;
           }
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="login-page" class="items-center justify-center min-h-screen bg-gray-900 text-gray-200">
        <div class="relative flex flex-col m-6 space-y-8 bg-gray-800 shadow-2xl rounded-2xl md:flex-row md:space-y-0">
            <div class="flex flex-col justify-center p-8 md:p-14">
                <span class="mb-3 text-4xl font-bold text-white">Stock Management</span>
                <span class="font-light text-gray-400 mb-8">Please enter your details to sign in</span>
                <form id="login-form" class="space-y-6">
                     <div>
                        <label for="email" class="text-sm font-medium text-gray-300">Email address</label>
                        <input id="email" name="email" type="email" autocomplete="email" required class="input-dark" placeholder="you@example.com">
                    </div>
                    <div>
                        <label for="password" class="text-sm font-medium text-gray-300">Password</label>
                        <input id="password" name="password" type="password" autocomplete="current-password" required class="input-dark" placeholder="••••••••">
                    </div>
                    <div>
                        <button type="submit" class="w-full px-4 py-3 font-bold text-white bg-emerald-600 rounded-md hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-emerald-500 transition-colors">Sign In</button>
                    </div>
                    <p id="login-error" class="text-sm text-center text-red-400 h-4"></p>
                </form>
            </div>
            <div class="relative hidden md:block">
                <img src="https://placehold.co/400x550/047857/FFFFFF?text=Stock\nApp\n---\nSecure" alt="A placeholder image with the text 'Stock App Secure'" class="w-[400px] h-full hidden rounded-r-2xl md:block object-cover" />
            </div>
        </div>
    </div>

    <div id="app-page" class="h-screen bg-gray-200 hidden">
        <div class="no-print w-64 bg-emerald-700 text-white flex flex-col fixed left-0 top-0 h-full z-30">
            <div class="px-8 py-6 text-2xl font-bold border-b border-gray-700">Stock App</div>
            <nav class="flex-1 px-4 py-4 space-y-2">
                <a href="#" class="sidebar-link flex items-center px-4 py-2 rounded-md hover:bg-gray-700" data-page="customers-page">Customers</a>
                <a href="#" class="sidebar-link flex items-center px-4 py-2 rounded-md hover:bg-gray-700" data-page="stock-page">Stock</a>
                <a href="#" class="sidebar-link flex items-center px-4 py-2 rounded-md hover:bg-gray-700" data-page="transport-page">Transport</a>
                <a href="#" class="sidebar-link flex items-center px-4 py-2 rounded-md hover:bg-gray-700" data-page="invoices-page">Invoices</a>
                <a href="#" class="sidebar-link flex items-center px-4 py-2 rounded-md hover:bg-gray-700" data-page="billing-page">Billing</a>
                <a href="#" id="sign-out-button" class="flex items-center px-4 py-2 mt-auto text-red-400 rounded-md hover:bg-red-800 hover:text-white">Sign Out</a>
            </nav>
            <div class="px-4 py-4 border-t border-gray-700">
                <p class="text-sm text-gray-400">Signed in as</p>
                <p id="user-id" class="font-semibold font-mono text-xs break-all"></p>
            </div>
        </div>

       <main class="flex-1 p-6 flex flex-col ml-64">
            <div id="customers-page" class="app-content active flex-1"></div>
            <div id="stock-page" class="app-content flex-1"></div>
            <div id="transport-page" class="app-content flex-1"></div>
            <div id="invoices-page" class="app-content flex-1"></div>
            <div id="billing-page" class="app-content flex-1"></div>
       </main>

    </div>

    <div id="loading-overlay" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="text-white text-xl font-semibold">
            <p id="loading-text">Processing...</p>
        </div>
    </div>

    <div id="modals-container"></div>
    <div id="invoice-print-view"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, onSnapshot, addDoc, setDoc, doc, getDoc, query, deleteDoc, where, writeBatch, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let isAppInitialized = false;

        const firebaseConfig = {
            apiKey: "AIzaSyDHkL-nr1M2vxYzUNjNi2fu8SPfXEQPCHU",
            authDomain: "stockmanagment-a60c2.firebaseapp.com",
            projectId: "stockmanagment-a60c2",
            storageBucket: "stockmanagment-a60c2.appspot.com",
            messagingSenderId: "295896107616",
            appId: "1:295896107616:web:9197f687214c8c7c47d105"
        };
        const appId = 'secure-team-stock-tracker';
        // ========= THIS IS THE FINAL, CORRECTED PATH =========
        const COL = (name) => collection(db, `artifacts/${appId}/${name}`);

        let db, auth, userId;
        let customersList = [], stockList = [], transportList = [], invoiceList = [], stemsList = [];
        let confirmCallback = null, currentImportConfig = null, clearBeforeImport = false;
        let hideZeroBalances = true;
        let invoiceCustomerFilter = '';
        let transportCustomerFilter = '';
        let currentStorageBillData = null;
        let currentTransportBillData = null;
        let currentStockFeeData = null;

        let stockFilters = {
            Customer: '', PackingDateFrom: '', PackingDateTo: '',
            EndDateFrom: '', EndDateTo: ''
        };

        const norm = (v) => String(v ?? '').trim().toUpperCase();
        function parseCurrency(val) {
            if (val === undefined || val === null || val === '') return 0;
            if (typeof val === 'number') return Number.isFinite(val) ? val : 0;
            const cleaned = String(val).replace(/[^0-9.-]+/g, '');
            const n = parseFloat(cleaned);
            return Number.isFinite(n) ? n : 0;
        }
        function addDaysYYYYMMDD(yyyyMMdd, days) { if (!yyyyMMdd) return ''; const [y, m, d] = yyyyMMdd.split('-').map(Number); if (!y || !m || !d) return ''; const dt = new Date(Date.UTC(y, m - 1, d)); dt.setUTCDate(dt.getUTCDate() + days); return [dt.getUTCFullYear(), String(dt.getUTCMonth() + 1).padStart(2, '0'), String(dt.getUTCDate()).padStart(2, '0')].join('-'); }
        function formatNumberWithCommas(val, dec = 0) { const n = parseFloat(val); if (isNaN(n)) return val ?? ''; return n.toLocaleString('en-US', { minimumFractionDigits: dec, maximumFractionDigits: dec }); }
        function formatDate(d) { if (!d) return ''; if (d.seconds) d = new Date(d.seconds * 1000); else if (typeof d === 'string' || typeof d === 'number') d = new Date(d); if (isNaN(d.getTime())) return ''; const y = d.getFullYear(), m = String(d.getMonth() + 1).padStart(2, '0'), day = String(d.getDate()).padStart(2, '0'); return `${y}-${m}-${day}`; }
        function uniq(arr) { return [...new Set(arr.filter(Boolean))]; }
        function parseDateYYYYMMDD(s) { if (!s) return null; const [y, m, d] = s.split('-').map(Number); if (!y || !m || !d) return null; return new Date(y, m - 1, d).getTime(); }
        function inRange(val, min, max) { if (min !== '' && val < min) return false; if (max !== '' && val > max) return false; return true; }
        function showLoading(show, text = 'Processing...') { const ov = document.getElementById('loading-overlay'); const p = document.getElementById('loading-text'); if (p) p.textContent = text; if (ov) ov.classList.toggle('hidden', !show); }
        const cmpStr = (a, b) => String(a ?? '').localeCompare(String(b ?? ''));

        document.addEventListener('DOMContentLoaded', () => {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setupEventListeners();
            onAuthStateChanged(auth, (user) => {
                const loginPage = document.getElementById('login-page');
                const appPage = document.getElementById('app-page');
                if (user && !user.isAnonymous) {
                    userId = user.uid;
                    loginPage.style.display = 'none';
                    appPage.classList.remove('hidden');
                    if (!isAppInitialized) {
                        initializeAppState();
                    }
                    document.getElementById('user-id').textContent = user.email || userId;
                } else {
                    isAppInitialized = false;
                    loginPage.style.display = 'flex';
                    appPage.classList.add('hidden');
                }
            });
        });

        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorElement = document.getElementById('login-error');
            errorElement.textContent = '';
            showLoading(true, 'Signing In...');
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                errorElement.textContent = error.message;
            } finally {
                showLoading(false);
            }
        }

        function initializeAppState() {
          injectAllContentAndModals();
          setupAppEventListeners();
          setupDataListeners();
          isAppInitialized = true;
      }

        const customerConfig = { title: "Customer", collectionName: 'customers', headers: ["No", "Name", "Remark", "Actions"], keys: ["No", "Name", "Remark"], sample: [{ No: 1, Name: "Customer A", Remark: "VIP" }] };
        const stockConfig = {
            title: "Stock", collectionName: 'stock',
            headers: ["No", "Category", "Process No", "Customer", "Packing Date", "End Date", "Grade", "Crop Year", "QTY Cases", "QTY Remnant (Kg)", "Box Type", "Case Tare Weight", "Packing Unit", "Total Case", "Total Kg", "Stock Deliver (Case)", "Stock Deliver (Kg)", "Stock Balance (Cases)", "Stock Balance (Kgs)", "Alert", "Actions"],
            keys: ["No", "Category", "ProcessNo", "Customer", "PackingDate", "EndDate", "Grade", "CropYear", "QtyCases", "QtyRemnantKg", "BoxType", "CaseTareWeight", "PackingUnit", "TotalCase", "TotalKg", "StockDeliverCase", "StockDeliverKg", "StockBalanceCases", "StockBalanceKgs", "Alert"],
            sample: [{ Category: "Lamina", ProcessNo: "P001", Customer: "Customer A", PackingDate: "2025-08-01", Grade: "A1", CropYear: 2025, QtyCases: 100, QtyRemnantKg: 5.5, BoxType: "New", CaseTareWeight: 1.2, PackingUnit: 25, UnitPrice: 0.55 }] };
        const transportConfig = {
            title: "Transport", collectionName: 'transport',
            headers: ["No.", "Delivery Date", "Customer", "Process No.", "Grade", "QTY Case", "QTY (Kg)", "PO By Clark", "Truck No.", "Price/USD", "Warehouse Clark", "Includes Remnant", "Actions"],
            keys: ["No", "DateDelivery", "Customer", "ProcessNo", "Grade", "Quantity_BOX", "Quantity_Kgs", "POByClark", "TruckNo", "PriceUSD", "WarehouseClark", "IncludesRemnant"],
            sample: [{"Delivery Date": "2025-08-05", "Customer": "Customer A", "Process No.": "P001", "Grade": "A1", "QTY Case": 10, "QTY (Kg)": 150.50, "PO By Clark": "Clark Kent", "Truck No.": "T-123", "Price/USD": 300, "Warehouse Clark": "Diana Prince", "Includes Remnant": false, "Receiver No.": "REC-001", "Receiver Code": "RCODE-XYZ", "Road": "21A", "KM": 40, "Deliver to": "District A" }]
        };
        const invoiceConfig = {
            title: "Invoice", collectionName: 'invoices',
            headers: ["No.", "Invoice Number", "Customer Name", "Date of Invoice", "Description", "Comment", "Amount on Invoice", "Amount Paid", "Pay Date", "Invoice Balance", "Actions"],
            keys: ["No", "InvoiceID", "Customer", "InvoiceDate", "Description", "Comment", "Amount", "AmountPaid", "PayDate"],
            sample: [{ No: 1, InvoiceID: "INV-2025-001", Customer: "Customer A", InvoiceDate: "2025-08-09", Description: "Goods provided", Comment: "First payment", Amount: 4909.00, AmountPaid: 2000.00, PayDate: "2025-08-15" }]
        };

        function injectAllContentAndModals() {
          document.getElementById('customers-page').innerHTML = `<div class="bg-white rounded-lg shadow flex flex-col flex-1"><div class="p-6 flex justify-between items-center no-print"><h2 class="text-xl font-semibold">Customer List</h2><div class="flex space-x-2"><button id="download-customers-sample" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Sample</button><button id="import-customers-button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Import</button><button id="add-customer-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Add New</button></div></div><div class="table-scroll flex-1"><table class="min-w-full divide-y divide-gray-200"><thead id="customers-header"></thead><tbody id="customers-body" class="bg-white divide-y divide-gray-200"></tbody></table></div></div>`;
          document.getElementById('stock-page').innerHTML = `<div class="bg-white rounded-lg shadow flex flex-col flex-1">
                <div class="p-6 flex justify-between items-center no-print">
                    <h2 class="text-xl font-semibold">Overall Stock</h2>
                    <div class="flex items-center space-x-4">
                        <label class="flex items-center space-x-2"><input type="checkbox" id="hide-zero-balances-toggle" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" checked><span>Hide Zero Balances</span></label>
                        <div class="flex items-center space-x-2">
                            <button id="clear-stock-toggle" class="clear-import-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg transition-colors">Clear Before Import</button>
                            <button id="download-stock-sample" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Sample</button>
                            <button id="import-stock-button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Import</button>
                            <button id="add-stock-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Add New</button>
                        </div>
                    </div>
                </div>
                <div class="table-scroll flex-1 relative min-h-0 overflow-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead id="stock-header" class="bg-white"></thead>
                        <tbody id="stock-body" class="bg-white divide-y divide-gray-200"></tbody>
                        <tfoot id="stock-footer"></tfoot>
                    </table>
                </div>
            </div>`;
          document.getElementById('transport-page').innerHTML = `<div class="bg-white rounded-lg shadow flex flex-col flex-1"><div class="p-6 flex justify-between items-center no-print"><div class="flex items-center space-x-4"><h2 class="text-xl font-semibold">Transport Log</h2><label class="flex items-center space-x-2"><span>Filter:</span><select id="transport-customer-filter" class="input w-48"></select></label></div><div class="flex items-center space-x-2"><button id="clear-transport-toggle" class="clear-import-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg transition-colors">Clear Before Import</button><button id="download-transport-sample" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Sample</button><button id="import-transport-button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Import</button><button id="add-transport-button" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg">Add New</button></div></div><div class="table-scroll flex-1 relative min-h-0 overflow-auto"><table class="min-w-full divide-y divide-gray-200"><thead id="transport-header" class="bg-gray-50"></thead><tbody id="transport-body" class="bg-white divide-y divide-gray-200"></tbody><tfoot id="transport-footer"></tfoot></table></div></div>`;
          document.getElementById('billing-page').innerHTML = `<div class="bg-white rounded-lg shadow p-6 flex-1 flex flex-col space-y-8 overflow-y-auto">
                <div id="billing-invoice-preview-container" class="hidden"></div>
                <div>
                    <div class="no-print">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Generate Reports & Invoices</h2>
                        <div id="report-tabs" class="flex border-b">
                            <button data-panel="stock-report-panel" class="report-tab-button py-2 px-4 border-b-2 font-medium text-gray-500 hover:text-gray-700 transition-colors active">Stock Fee Report</button>
                            <button data-panel="transport-report-panel" class="report-tab-button py-2 px-4 border-b-2 font-medium text-gray-500 hover:text-gray-700 transition-colors">Transport Billing</button>
                            <button data-panel="storage-billing-panel" class="report-tab-button py-2 px-4 border-b-2 font-medium text-gray-500 hover:text-gray-700 transition-colors">Storage Billing</button>
                        </div>
                    </div>
                    <div id="stock-report-panel" class="report-panel active py-4">
                        <div class="no-print grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div><label for="report-customer" class="block text-sm font-medium text-gray-700">Customer</label><select id="report-customer" class="input"></select></div>
                            <div><label for="report-process-no" class="block text-sm font-medium text-gray-700">Process No.</label><select id="report-process-no" class="input"></select></div>
                            <div><label class="block text-sm font-medium text-gray-700">&nbsp;</label><button id="generate-report-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Generate Stock Fee Report</button></div>
                        </div>
                        <div id="report-view" class="mt-6 border-t pt-6"></div>
                    </div>
                    <div id="transport-report-panel" class="report-panel py-4">
                        <div class="no-print grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                            <div><label for="tr-report-customer" class="block text-sm font-medium text-gray-700">Customer</label><select id="tr-report-customer" class="input"></select></div>
                            <div><label for="tr-date-from" class="block text-sm font-medium text-gray-700">Start Date</label><input type="date" id="tr-date-from" class="input"></div>
                            <div><label for="tr-date-to" class="block text-sm font-medium text-gray-700">End Date</label><input type="date" id="tr-date-to" class="input"></div>
                            <div class="flex items-end"><button id="tr-generate-report-button" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Generate Bill</button></div>
                        </div>
                        <div id="tr-report-view" class="mt-6 border-t pt-6"></div>
                    </div>
                    <div id="storage-billing-panel" class="report-panel py-4">
                        <div class="no-print grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div><label for="sb-customer" class="block text-sm font-medium text-gray-700">Customer</label><select id="sb-customer" class="input"></select></div>
                            <div><label for="sb-month" class="block text-sm font-medium text-gray-700">Month</label><input id="sb-month" type="month" class="input"/></div>
                            <div class="flex items-end"><button id="sb-generate" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Generate Storage Bill</button></div>
                        </div>
                        <div id="sb-view" class="mt-6 border-t pt-6"></div>
                    </div>
                </div>
            </div>`;
          document.getElementById('invoices-page').innerHTML = `<div class="bg-white rounded-lg shadow flex flex-col flex-1"><div class="p-6 flex justify-between items-center no-print"><div class="flex items-center space-x-4"><h2 class="text-xl font-semibold">Invoice List</h2><label class="flex items-center space-x-2"><span>Filter:</span><select id="invoice-customer-filter" class="input w-48"></select></label></div><div class="flex space-x-2"><button id="record-payment-button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Record Payment</button><button id="add-new-invoice-manual-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg">Add Manual Invoice</button><button id="clear-invoices-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Clear All</button></div></div><div class="table-scroll flex-1 relative min-h-0 overflow-auto"><table class="min-w-full divide-y divide-gray-200"><thead id="invoices-header" class="sticky top-0 bg-gray-50 z-10"></thead><tbody id="invoices-body" class="bg-white divide-y divide-gray-200"></tbody><tfoot id="invoices-footer"></tfoot></table></div></div>`;
          document.getElementById('modals-container').innerHTML = `<div id="customer-modal" class="modal-overlay hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-40 p-4"><div class="modal-container relative top-20 mx-auto w-full max-w-lg shadow-lg rounded-2xl bg-white"><div class="p-8"><h3 id="customer-modal-title" class="text-2xl font-bold text-center text-gray-800 mb-6"></h3><form id="customer-form" class="space-y-6"><input type="hidden" id="customer-id"><div><label for="customer-name" class="block text-sm font-medium text-gray-700">Customer Name</label><input type="text" id="customer-name" class="input" required></div><div><label for="customer-remark" class="block text-sm font-medium text-gray-700">Remark</label><input type="text" id="customer-remark" class="input"></div></form><div class="items-center pt-8 flex justify-center space-x-4"><button id="customer-modal-cancel-button" class="font-bold py-3 px-6 rounded-lg">Cancel</button><button id="customer-modal-save-button" class="font-bold py-3 px-6 rounded-lg bg-indigo-600 text-white">Save</button></div></div></div></div><div id="stock-modal" class="modal-overlay hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-40 p-4"><div class="modal-container relative top-10 mx-auto w-full max-w-5xl shadow-lg rounded-2xl bg-white"><div class="p-8"><h3 id="stock-modal-title" class="text-2xl font-bold text-center text-gray-800 mb-6"></h3><form id="stock-form" class="grid grid-cols-1 md:grid-cols-4 gap-6"><input type="hidden" id="stock-id"><div><label for="stock-ProcessNo">Process No</label><input type="text" id="stock-ProcessNo" class="input"></div><div><label for="stock-Customer">Customer</label><select id="stock-Customer" class="input"></select></div><div><label for="stock-Category">Category</label><select id="stock-Category" class="input"><option value="Lamina">Lamina</option><option value="Stems">Stems</option></select></div><div><label for="stock-PackingDate">Packing Date</label><input type="date" id="stock-PackingDate" class="input"></div><div><label for="stock-EndDate">End Date</label><input type="date" id="stock-EndDate" class="input bg-gray-200" readonly></div><div><label for="stock-Grade">Grade</label><input type="text" id="stock-Grade" class="input"></div><div><label for="stock-CropYear">Crop Year</label><input type="text" id="stock-CropYear" class="input"></div><div><label for="stock-QtyCases">QTY Cases</label><input type="number" id="stock-QtyCases" class="input"></div><div><label for="stock-QtyRemnantKg">QTY Remnant (Kg)</label><input type="number" step="0.01" id="stock-QtyRemnantKg" class="input"></div><div><label for="stock-BoxType">Box Type</label><select id="stock-BoxType" class="input"><option>New</option><option>Second Hand</option></select></div><div><label for="stock-CaseTareWeight">Case Tare Weight (Kg)</label><input type="number" step="0.01" id="stock-CaseTareWeight" class="input"></div><div><label for="stock-PackingUnit">Packing Unit (Kg)</label><input type="number" step="0.01" id="stock-PackingUnit" class="input"></div><div><label for="stock-UnitPrice" id="stock-unit-price-label">Unit Price/KG ($)</label><input type="number" step="0.01" id="stock-UnitPrice" class="input" value="0.55"></div></form><div class="items-center pt-8 flex justify-center space-x-4"><button id="stock-modal-cancel-button" class="font-bold py-3 px-6 rounded-lg">Cancel</button><button id="stock-modal-save-button" class="font-bold py-3 px-6 rounded-lg bg-blue-600 text-white">Save</button></div></div></div></div><div id="transport-modal" class="modal-overlay hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-40 p-4"><div class="modal-container relative top-10 mx-auto w-full max-w-6xl shadow-lg rounded-2xl bg-white"><div class="p-8"><h3 id="transport-modal-title" class="text-2xl font-bold text-center text-gray-800 mb-6"></h3><form id="transport-form" class="grid grid-cols-1 md:grid-cols-4 gap-6"><input type="hidden" id="transport-id"><div><label for="transport-DateDelivery">Delivery Date</label><input type="date" id="transport-DateDelivery" class="input"></div><div><label for="transport-Customer">Customer</label><select id="transport-Customer" class="input"></select></div><div><label for="transport-ProcessNo">Process No</label><select id="transport-ProcessNo" class="input"></select></div><div><label for="transport-Grade">Grade</label><select id="transport-Grade" class="input"></select></div><div><label for="transport-Quantity_BOX">QTY Case</label><input type="number" id="transport-Quantity_BOX" class="input"></div><div class="flex items-center pt-5"><input type="checkbox" id="transport-IncludesRemnant" class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"><label for="transport-IncludesRemnant" class="ml-2 text-sm font-medium text-gray-900">Includes Remnant Box</label></div><div><label for="transport-POByClark">PO By Clark</label><input type="text" id="transport-POByClark" class="input"></div><div><label for="transport-TruckNo">Truck No.</label><input type="text" id="transport-TruckNo" class="input"></div><div><label for="transport-PriceUSD">Price/USD</label><input type="number" step="0.01" id="transport-PriceUSD" class="input"></div><div><label for="transport-WarehouseClark">Warehouse Clark</label><input type="text" id="transport-WarehouseClark" class="input"></div><div><label for="transport-ReceiverNo">Receiver No.</label><input type="text" id="transport-ReceiverNo" class="input"></div><div><label for="transport-ReceiverCode">Receiver Code</label><input type="text" id="transport-ReceiverCode" class="input"></div><div><label for="transport-Road">Road</label><input type="text" id="transport-Road" class="input"></div><div><label for="transport-KM">KM</label><input type="text" id="transport-KM" class="input"></div><div><label for="transport-DeliverTo">Deliver to</label><input type="text" id="transport-DeliverTo" class="input"></div></form><div class="items-center pt-8 flex justify-center space-x-4"><button id="transport-modal-cancel-button" class="font-bold py-3 px-6 rounded-lg">Cancel</button><button id="transport-modal-save-button" class="font-bold py-3 px-6 rounded-lg bg-teal-600 text-white">Save</button></div></div></div></div><div id="confirmation-modal" class="modal-overlay hidden fixed inset-0 bg-gray-600 bg-opacity-70 z-50"><div class="modal-container relative top-40 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white"><div class="mt-3 text-center"><h3 class="text-lg leading-6 font-medium text-gray-900 mt-2">Are you sure?</h3><div class="mt-2 px-7 py-3"><p id="confirmation-message" class="text-sm text-gray-500"></p></div><div class="items-center px-4 py-3 flex justify-center space-x-4"><button id="confirm-cancel-button" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md w-24">Cancel</button><button id="confirm-ok-button" class="px-4 py-2 bg-red-600 text-white rounded-md w-24">Delete</button></div></div></div></div><div id="payment-modal" class="modal-overlay hidden fixed inset-0 bg-gray-600 bg-opacity-50 z-40 p-4"><div class="modal-container relative top-20 mx-auto w-full max-w-lg shadow-lg rounded-2xl bg-white"><div class="p-8"><h3 id="payment-modal-title" class="text-2xl font-bold text-center mb-6">Record Payment</h3><form id="payment-form" class="space-y-6"><input type="hidden" id="payment-invoice-id"><div><label for="payment-customer-select" class="block text-sm font-medium">Customer</label><select id="payment-customer-select" class="input"></select></div><div><label for="payment-invoice-select" class="block text-sm font-medium">Invoice Number</label><select id="payment-invoice-select" class="input"></select></div><div><label class="block text-sm font-medium">Total Amount</label><p id="payment-total-amount" class="mt-2 font-semibold"></p></div><div><label for="payment-amount-paid" class="block text-sm font-medium">Amount to Pay</label><input type="number" step="0.01" id="payment-amount-paid" class="input"></div><div><label for="payment-pay-date" class="block text-sm font-medium">Payment Date</label><input type="date" id="payment-pay-date" class="input"></div></form><div class="items-center pt-8 flex justify-end space-x-4"><button id="payment-modal-cancel-button" class="font-bold py-3 px-6 rounded-lg">Cancel</button><button id="payment-modal-save-button" class="font-bold py-3 px-6 rounded-lg bg-green-600 text-white">Save Payment</button></div></div></div></div><div id="invoice-modal" class="modal-overlay hidden fixed inset-0 bg-gray-600 bg-opacity-50 z-40 p-4"><div class="modal-container relative top-10 mx-auto w-full max-w-5xl shadow-lg rounded-2xl bg-white"><div class="p-8"><h3 id="invoice-modal-title" class="text-2xl font-bold text-center text-gray-800 mb-6"></h3><form id="invoice-form" class="space-y-6"><input type="hidden" id="invoice-id"><div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div><label for="invoice-InvoiceID" class="block text-sm font-medium">Invoice Number</label><input type="text" id="invoice-InvoiceID" class="input bg-gray-200" readonly></div><div><label for="invoice-Customer" class="block text-sm font-medium">Customer Name</label><select id="invoice-Customer" class="input"></select></div><div><label for="invoice-InvoiceDate" class="block text-sm font-medium">Date of Invoice</label><input type="date" id="invoice-InvoiceDate" class="input"></div></div><div id="invoice-items-container" class="space-y-2 border-t border-b py-4"></div><button type="button" id="add-invoice-item-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg">+ Add Item</button><div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-4 border-t"><div><label for="invoice-Comment" class="block text-sm font-medium">Comment / Notes</label><textarea id="invoice-Comment" class="input h-20"></textarea></div><div class="space-y-4"><div><label for="invoice-AmountPaid" class="block text-sm font-medium">Amount Paid</label><input type="number" step="0.01" id="invoice-AmountPaid" class="input" value="0.00"></div><div><label for="invoice-PayDate" class="block text-sm font-medium">Pay Date</label><input type="date" id="invoice-PayDate" class="input"></div></div></div></form><div class="items-center pt-8 flex justify-end space-x-4"><button id="invoice-modal-cancel-button" class="font-bold py-3 px-6 rounded-lg">Cancel</button><button id="invoice-modal-save-button" class="font-bold py-3 px-6 rounded-lg bg-purple-600 text-white">Save</button></div></div></div></div>`;
        }

        function setupEventListeners() {
             document.getElementById('login-form').addEventListener('submit', handleLogin);
             document.getElementById('app-page').addEventListener('click', (e) => {
                const bill = e.target.closest('.bill-link');
                if (!bill) return;

                e.preventDefault();
                const cust = bill.dataset.customer || '';
                const reportsLink = document.querySelector('.sidebar-link[data-page="billing-page"]');
                if (reportsLink) reportsLink.click();

                const m = new Date();
                const ym = `${m.getFullYear()}-${String(m.getMonth()+1).padStart(2,'0')}`;

                const custSel = document.getElementById('sb-customer');
                const monthInp = document.getElementById('sb-month');
                if (custSel) custSel.value = cust;
                if (monthInp) monthInp.value = ym;

                renderStorageBillReport(cust, ym);

                document.querySelectorAll('.report-tab-button, .report-panel').forEach(el => el.classList.remove('active'));
                document.querySelector('.report-tab-button[data-panel="storage-billing-panel"]').classList.add('active');
                document.getElementById('storage-billing-panel').classList.add('active');
            });
        }

        function setupAppEventListeners() {
            document.getElementById('sign-out-button').addEventListener('click', () => signOut(auth));

            document.getElementById('app-page').addEventListener('click', e => {
                const target = e.target;
                const link = target.closest('.sidebar-link');
                const editBtn = target.closest('.edit-btn');
                const delBtn = target.closest('.delete-btn');
                const billLink = target.closest('.bill-link');
                const createStorageInvoiceBtn = target.closest('#create-invoice-from-storage-btn');
                const createTransportInvoiceBtn = target.closest('#create-invoice-from-transport-btn');
                const createStockFeeInvoiceBtn = target.closest('#create-invoice-from-stock-fee-btn');
                const printBtn = target.closest('.print-invoice-btn');

                if (link) {
                    e.preventDefault();
                    document.querySelectorAll('.sidebar-link, .app-content').forEach(el => el.classList.remove('active'));
                    link.classList.add('active');
                    const pageId = link.dataset.page;
                    const page = document.getElementById(pageId);
                    if (page) page.classList.add('active');

                    if (pageId === 'billing-page') {
                        const previewDiv = document.getElementById('billing-invoice-preview-container');
                        if (previewDiv) previewDiv.classList.add('hidden');
                    }
                    return;
                }
                if (editBtn) {
                    const { id, type } = editBtn.dataset;
                    if (type === 'customers') openCustomerModal(id);
                    if (type === 'stock') openStockModal(id);
                    if (type === 'transport') openTransportModal(id);
                    if (type === 'invoices') openInvoiceModal(id);
                    return;
                }
                if (delBtn) {
                    const { id, type, name } = delBtn.dataset;
                    if (type === 'customers') deleteCustomer(id, name);
                    else deleteItem(type, id, name);
                    return;
                }
                if (billLink) {
                    e.preventDefault();
                    const cust = billLink.dataset.customer || '';
                    document.querySelector('.sidebar-link[data-page="billing-page"]').click();
                    document.querySelectorAll('.report-tab-button, .report-panel').forEach(el => el.classList.remove('active'));
                    const storageTab = document.querySelector('.report-tab-button[data-panel="storage-billing-panel"]');
                    if(storageTab) storageTab.classList.add('active');
                    const storagePanel = document.getElementById('storage-billing-panel');
                    if(storagePanel) storagePanel.classList.add('active');

                    const m = new Date();
                    const ym = `${m.getFullYear()}-${String(m.getMonth()+1).padStart(2,'0')}`;
                    document.getElementById('sb-customer').value = cust;
                    document.getElementById('sb-month').value = ym;
                    renderStorageBillReport(cust, ym);
                    return;
                }
                if (createStorageInvoiceBtn) {
                    createInvoiceFromStorageBill();
                    return;
                }
                 if (createTransportInvoiceBtn) {
                    createInvoiceFromTransportBill();
                    return;
                }
                if (createStockFeeInvoiceBtn) {
                    createInvoiceFromStockFee();
                    return;
                }
                if (printBtn) {
                  renderInvoiceForPrint(printBtn.dataset.id);
                  return;
                }
            });

            document.getElementById('add-customer-button').addEventListener('click', () => openCustomerModal());
            document.getElementById('add-stock-button').addEventListener('click', () => openStockModal());
            document.getElementById('add-transport-button').addEventListener('click', () => openTransportModal());
            document.getElementById('clear-invoices-button').addEventListener('click', clearInvoices);
            document.getElementById('add-new-invoice-manual-btn').addEventListener('click', () => openInvoiceModal());
            document.getElementById('record-payment-button').addEventListener('click', () => openPaymentModal());

            document.getElementById('customer-modal-cancel-button').addEventListener('click', () => document.getElementById('customer-modal').classList.add('hidden'));
            document.getElementById('customer-modal-save-button').addEventListener('click', saveCustomer);
            document.getElementById('stock-modal-cancel-button').addEventListener('click', () => document.getElementById('stock-modal').classList.add('hidden'));
            document.getElementById('stock-modal-save-button').addEventListener('click', saveStock);
            document.getElementById('transport-modal-cancel-button').addEventListener('click', () => document.getElementById('transport-modal').classList.add('hidden'));
            document.getElementById('transport-modal-save-button').addEventListener('click', saveTransport);
            document.getElementById('invoice-modal-cancel-button').addEventListener('click', () => document.getElementById('invoice-modal').classList.add('hidden'));
            document.getElementById('invoice-modal-save-button').addEventListener('click', saveInvoice);
            document.getElementById('payment-modal-cancel-button').addEventListener('click', () => document.getElementById('payment-modal').classList.add('hidden'));
            document.getElementById('payment-modal-save-button').addEventListener('click', savePayment);
            document.getElementById('confirm-cancel-button').addEventListener('click', () => { document.getElementById('confirmation-modal').classList.add('hidden'); confirmCallback = null; });
            document.getElementById('confirm-ok-button').addEventListener('click', () => { if (confirmCallback) confirmCallback(); document.getElementById('confirmation-modal').classList.add('hidden'); confirmCallback = null; });

            document.getElementById('hide-zero-balances-toggle').addEventListener('change', e => { hideZeroBalances = e.target.checked; renderStockTable(); });
            document.getElementById('invoice-customer-filter').addEventListener('change', e => { invoiceCustomerFilter = e.target.value; renderInvoicesTable(); });
            document.getElementById('transport-customer-filter').addEventListener('change', e => { transportCustomerFilter = e.target.value; renderTransportTable(); });

            const fileUploadInput = document.createElement('input');
            fileUploadInput.type = 'file'; fileUploadInput.accept = '.xlsx,.xls'; fileUploadInput.style.display = 'none';
            document.body.appendChild(fileUploadInput);
            document.getElementById('import-customers-button').addEventListener('click', () => { currentImportConfig = customerConfig; fileUploadInput.click(); });
            document.getElementById('import-stock-button').addEventListener('click', () => { currentImportConfig = stockConfig; fileUploadInput.click(); });
            document.getElementById('import-transport-button').addEventListener('click', () => { currentImportConfig = transportConfig; fileUploadInput.click(); });
            fileUploadInput.addEventListener('change', e => handleFileUpload(e, currentImportConfig));
            document.getElementById('download-customers-sample').addEventListener('click', () => downloadSample(customerConfig));
            document.getElementById('download-stock-sample').addEventListener('click', () => downloadSample(stockConfig));
            document.getElementById('download-transport-sample').addEventListener('click', () => downloadSample(transportConfig));

            document.body.addEventListener('click', e => {
                const clearBtn = e.target.closest('.clear-import-btn');
                if (clearBtn) {
                    clearBeforeImport = !clearBeforeImport;
                    document.querySelectorAll('.clear-import-btn').forEach(btn => {
                        btn.classList.toggle('bg-red-600', clearBeforeImport);
                        btn.classList.toggle('text-white', clearBeforeImport);
                        btn.classList.toggle('bg-gray-200', !clearBeforeImport);
                        btn.classList.toggle('text-gray-700', !clearBeforeImport);
                    });
                }
                const tabButton = e.target.closest('.report-tab-button');
                if (tabButton) {
                    document.querySelectorAll('.report-tab-button, .report-panel').forEach(el => el.classList.remove('active'));
                    tabButton.classList.add('active');
                    const panel = document.getElementById(tabButton.dataset.panel);
                    if (panel) panel.classList.add('active');
                }
            });

            wireReportControls();
            wireTransportReportControls();

            const sbGenBtn = document.getElementById('sb-generate');
            if(sbGenBtn) {
                sbGenBtn.onclick = () => {
                    const cust = document.getElementById('sb-customer').value;
                    const ym = document.getElementById('sb-month').value;
                    if(!cust || !ym) {
                        alert('Please select a customer and a month.');
                        return;
                    }
                    renderStorageBillReport(cust, ym);
                };
            }
        }

        function setupDataListeners() {
          onSnapshot(query(COL('customers')), snap => {
              customersList = snap.docs.map(d => ({ id: d.id, ...d.data() }));
              renderCustomersTable();

              const dropdownIds = [
                  'sb-customer', 'report-customer', 'stock-Customer',
                  'transport-Customer', 'invoice-customer-filter', 'tr-report-customer',
                  'invoice-Customer'
              ];

              dropdownIds.forEach(id => {
                  const el = document.getElementById(id);
                  if (el) {
                      const currentVal = el.value;
                      el.innerHTML = `<option value="">-- Select --</option>` + customersList.map(c => `<option value="${c.Name}">${c.Name}</option>`).join('');
                      el.value = currentVal;
                  }
              });
              updateReportProcessNos();
          });

          onSnapshot(query(COL('stock')), snap => {
              stockList = snap.docs.map(d => ({ id: d.id, ...d.data() }));
              renderStockTable();
              updateReportProcessNos();
          });

          onSnapshot(query(COL('transport')), snap => {
              transportList = snap.docs.map(d => ({ id: d.id, ...d.data() }));
              renderTransportTable();
              initTransportCustomerFilter();
              renderStockTable();
          });

          onSnapshot(query(COL('invoices')), snap => {
              invoiceList = snap.docs.map(d => ({ id: d.id, ...d.data() }));
              renderInvoicesTable();
          });
        }

        function getCalculatedStockData(item) {
        const qtyCases = parseInt(item.QtyCases || 0);
        const packUnit = parseFloat(item.PackingUnit || 0);
        const rem = parseFloat(item.QtyRemnantKg || 0);

        const related = transportList.filter(t =>
          norm(t.ProcessNo) === norm(item.ProcessNo) &&
          norm(t.Customer)  === norm(item.Customer) &&
          norm(t.Grade)     === norm(item.Grade)
        );

        const deliveredCases = related.reduce((s, t) => s + (parseInt(t.Quantity_BOX) || 0), 0);
        const deliveredKg    = related.reduce((s, t) => s + transportKgOrFallback(t, item), 0);

        const totalCase = qtyCases + (rem > 0 ? 1 : 0);
        const totalKg   = (qtyCases * packUnit) + rem;

        const balanceCases = totalCase - deliveredCases;
        const balanceKgRaw = totalKg - deliveredKg;
        const balanceKg    = Math.abs(balanceKgRaw) < 0.01 ? 0 : Math.max(balanceKgRaw, 0);

        let alertMsg = '';
        if (item.PackingDate) {
          const pd = new Date(item.PackingDate), today = new Date();
          pd.setHours(0, 0, 0, 0); today.setHours(0, 0, 0, 0);
          if ((today - pd) / (1000 * 60 * 60 * 24) > 30 && balanceCases > 0) {
              alertMsg = `<a href="#" class="bill-link text-red-600 font-bold whitespace-nowrap" data-customer="${item.Customer}">Bill (${balanceCases}) Case(s)</a>`;
          }
        }

        return {
          ...item,
          TotalCase: totalCase,
          TotalKg: totalKg,
          StockDeliverCase: deliveredCases,
          StockDeliverKg: deliveredKg,
          StockBalanceCases: balanceCases,
          StockBalanceKgs: balanceKg,
          Alert: alertMsg
        };
        }
        function transportKgOrFallback(t, stockItem) {
          const qty = parseFloat(t.Quantity_BOX || 0) || 0;
          const pu  = parseFloat(stockItem.PackingUnit || 0) || 0;
          const rem = parseFloat(stockItem.QtyRemnantKg || 0) || 0;

          const saved = parseFloat(t.Quantity_Kgs);
          if (Number.isFinite(saved) && saved > 0) return saved;

          if (t.IncludesRemnant && qty > 0) {
            return ((qty - 1) * pu) + rem;
          }
          return qty * pu;
        }

        // --- All other functions from the original file are included below ---
        // ... (This represents all the remaining functions, which are identical to the original file)

    </script>
</body>
</html>
